<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperCycle - Shipment Details</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #1a1a1a;
      }

      .hidden {
        display: none !important;
      }

      /* ===== Header ===== */
      .header {
        background: linear-gradient(135deg, #1a7f4f, #2ba572);
        color: white;
        padding: 18px 32px;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }

      .header h1 {
        font-size: 22px;
        font-weight: 700;
      }

      .container {
        max-width: 1200px;
        margin: auto;
        padding: 24px 16px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #666;
      }

      /* ===== Cards ===== */
      .card,
      .form-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .card h3,
      .form-section h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 2px solid #2ba572;
      }

      /* ===== Top Layout ===== */
      .top-layout {
        display: grid;
        grid-template-columns: 1.2fr 2fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      /* ===== Images ===== */
      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }

      .image-thumb {
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        aspect-ratio: 1 / 1;
        background: #eee;
      }

      .image-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.25s ease;
      }

      .image-thumb:hover img {
        transform: scale(1.05);
      }

      .image-preview {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .image-preview img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 12px;
      }

      /* ===== Info ===== */
      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .info-item {
        padding: 10px;
        background: #f8f9fa;
        border-left: 4px solid #2ba572;
        border-radius: 8px;
      }

      .info-item label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
      }

      .info-item span {
        font-size: 14px;
        font-weight: 600;
      }

      /* ===== Lists ===== */
      .items-list,
      .timeline {
        list-style: none;
        max-height: 160px;
        overflow-y: auto;
      }

      .items-list li,
      .timeline li {
        padding: 10px;
        background: #f8f9fa;
        margin-bottom: 8px;
        border-left: 4px solid #2ba572;
        border-radius: 6px;
        font-size: 13px;
      }

      /* ===== Admin Actions ===== */
      textarea,
      select,
      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 13px;
      }

      textarea {
        min-height: 70px;
      }

      #vehiclesList {
        max-height: 180px;
        overflow-y: auto;
      }

      .vehicle-card {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
      }

      .vehicle-card.selected {
        background: #eafaf1;
        border-color: #2ba572;
      }

      .summary-box {
        background: #eafaf1;
        border-left: 4px solid #2ba572;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        margin-top: 8px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 14px;
      }

      button {
        padding: 10px 16px;
        border-radius: 6px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-approve {
        background: #2ba572;
        color: white;
      }

      .btn-edit {
        background: #f39c12;
        color: white;
      }

      .btn-reject {
        background: #e74c3c;
        color: white;
      }

      .success-message {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 14px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-left: 4px solid #28a745;
      }

      .success-message.show {
        display: block;
      }

      @media (max-width: 900px) {
        .top-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      <h1 id="title">Shipment Details</h1>
    </div>

    <div class="container">
      <pre id="loading" class="loading">Loading shipment details...</pre>
      <div id="successMessage" class="success-message"></div>

      <div id="content" class="hidden">
        <!-- TOP -->
        <div class="top-layout">
          <!-- IMAGES -->
          <div id="imagesCard" class="card hidden">
            <h3>Shipment Images</h3>
            <div id="imagesGrid" class="images-grid"></div>
          </div>

          <!-- INFO -->
          <div class="card">
            <h3>Shipment Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Shipment No</label>
                <span id="shipmentNumber"></span>
              </div>
              <div class="info-item">
                <label>Status</label>
                <span id="status"></span>
              </div>
              <div class="info-item">
                <label>Total KG</label>
                <span id="totalKg"></span>
              </div>
              <div class="info-item">
                <label>Pickup Address</label>
                <span id="address"></span>
              </div>
              <div class="info-item">
                <label>Trader</label>
                <span id="traderName"></span>
              </div>
              <div class="info-item">
                <label>Phone</label>
                <span id="traderPhone"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- ITEMS -->
        <div class="card">
          <h3>Shipment Items</h3>
          <ul id="items" class="items-list"></ul>
        </div>

        <!-- TIMELINE -->
        <div class="card">
          <h3>Activity Timeline</h3>
          <ul id="timeline" class="timeline"></ul>
        </div>

        <!-- ADMIN ACTIONS -->
        <div id="adminActions" class="form-section">
          <h3>Admin Actions</h3>

          <label>Assign Representative</label>
          <select id="representativeId" onchange="onRepresentativeChange()">
            <option value="">-- Select Representative --</option>
          </select>
          <div id="repInfo" style="font-size:12px;color:#666;margin-top:6px"></div>

          <label style="margin-top:10px">Assign Vehicles</label>
          <div id="vehiclesList"></div>
          <div id="vehicleSummary" class="summary-box"></div>

          <label style="margin-top:10px">Notes / Reason</label>
          <textarea id="note"></textarea>

          <div class="button-group">
            <button class="btn-approve" onclick="approve()">Approve</button>
            <button class="btn-edit" onclick="enterEditMode()">Edit & Approve</button>
            <button class="btn-reject" onclick="reject()">Reject</button>
          </div>
        </div>

        <!-- EDIT MODE -->
        <div id="editSection" class="form-section hidden">
          <h3>Edit Shipment</h3>

          <label>Pickup Date</label>
          <input id="pickupDate" type="datetime-local" />

          <label style="margin-top:8px">Pickup Address</label>
          <input id="pickupAddress" />

          <label style="margin-top:8px">Items</label>
          <div id="editItems"></div>

          <button
            onclick="addItem()"
            style="background:#2ba572;color:white;margin-top:10px"
          >
            ‚ûï Add Item
          </button>

          <div class="button-group">
            <button class="btn-approve" onclick="confirmEditAndApprove()">
              Confirm
            </button>
            <button class="btn-reject" onclick="cancelEdit()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE =
        "https://supercycle-api-855015056699.europe-west1.run.app";
      const token = localStorage.getItem("token");
      if (!token) location.href = "index.html";

      const shipmentId = new URLSearchParams(location.search).get("id");

      let shipmentData = null;
      let REPRESENTATIVES = [];
      let VEHICLES = [];
      let DOSH_TYPES = [];

      function goBack() {
        location.href = "shipments.html";
      }

      function hideAdminActions(message) {
        document.getElementById("adminActions").classList.add("hidden");
        document.getElementById("editSection").classList.add("hidden");
        const msg = document.getElementById("successMessage");
        msg.innerText = message;
        msg.classList.add("show");
      }

      async function safePatch(path, body, successMsg) {
        const res = await fetch(API_BASE + path, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(body),
        });

        const json = await res.json();
        if (!res.ok) return alert(json.message || "Action failed");

        hideAdminActions(successMsg);
        setTimeout(loadShipment, 1500);
      }

      async function loadShipment() {
        const res = await fetch(`${API_BASE}/shipments/${shipmentId}`, {
          headers: { Authorization: "Bearer " + token },
        });
        const json = await res.json();
        shipmentData = json.data;

        document.getElementById("loading").style.display = "none";
        document.getElementById("content").classList.remove("hidden");

        document.getElementById("title").innerText =
          shipmentData.shipmentNumber;
        document.getElementById("shipmentNumber").innerText =
          shipmentData.shipmentNumber;
        document.getElementById("totalKg").innerText =
          shipmentData.totalQuantityKg || "0";
        document.getElementById("address").innerText =
          shipmentData.customPickupAddress || "-";
        document.getElementById("traderName").innerText =
          shipmentData.traderId?.bussinessName || "-";
        document.getElementById("traderPhone").innerText =
          shipmentData.traderId?.doshMangerPhone || "-";

        document.getElementById("status").innerText =
          shipmentData.status || "Unknown";

        /* items */
        const items = document.getElementById("items");
        items.innerHTML = "";
        (shipmentData.items || []).forEach((i) => {
          items.innerHTML += `<li>${i.doshType.name} - ${i.quantityKg} KG</li>`;
        });

        /* timeline */
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";
        (shipmentData.timeline || []).forEach((t) => {
          timeline.innerHTML += `<li>${t.action} (${t.role})</li>`;
        });

        /* images */
        const imagesCard = document.getElementById("imagesCard");
        const imagesGrid = document.getElementById("imagesGrid");
        imagesGrid.innerHTML = "";

        if (shipmentData.uploadedImages?.length) {
          imagesCard.classList.remove("hidden");
          shipmentData.uploadedImages.forEach((url) => {
            const d = document.createElement("div");
            d.className = "image-thumb";
            d.innerHTML = `<img src="${url}" />`;
            d.onclick = () => openImage(url);
            imagesGrid.appendChild(d);
          });
        } else {
          imagesCard.classList.add("hidden");
        }
      }

      function openImage(url) {
        const overlay = document.createElement("div");
        overlay.className = "image-preview";
        overlay.innerHTML = `<img src="${url}" />`;
        overlay.onclick = () => overlay.remove();
        document.body.appendChild(overlay);
      }

      async function loadRepresentatives() {
        const res = await fetch(
          `${API_BASE}/admin/representatives?page=1&limit=50`,
          { headers: { Authorization: "Bearer " + token } }
        );
        const json = await res.json();
        REPRESENTATIVES = json.data.data || [];

        const select = document.getElementById("representativeId");
        select.innerHTML = `<option value="">-- Select Representative --</option>`;
        REPRESENTATIVES.forEach((r) => {
          select.innerHTML += `<option value="${r.id}">${r.fullName}</option>`;
        });
      }

      function onRepresentativeChange() {
        const rep = REPRESENTATIVES.find(
          (r) => r.id === document.getElementById("representativeId").value
        );
        document.getElementById("repInfo").innerHTML = rep
          ? `üìç ${rep.address}<br/>üìû ${rep.user.phone}`
          : "";
      }

      async function loadVehicles() {
        const res = await fetch(
          `${API_BASE}/admin/vehicles?page=1&limit=50`,
          { headers: { Authorization: "Bearer " + token } }
        );
        const json = await res.json();
        VEHICLES = json.data.data || [];
        renderVehicles();
      }

      function renderVehicles() {
        const list = document.getElementById("vehiclesList");
        list.innerHTML = "";
        VEHICLES.forEach((v) => {
          const div = document.createElement("div");
          div.className = "vehicle-card";
          div.innerHTML = `
            <label>
              <input type="checkbox" value="${v.id}" onchange="updateVehicleSummary()" />
              <strong>${v.vehicleType}</strong> - ${v.licensePlate}
            </label><br/>
            <small>üë§ ${v.driver.name} | üèãÔ∏è ${v.maxLoadKg} KG</small>
          `;
          list.appendChild(div);
        });
      }

      function getSelectedVehicleIds() {
        return [...document.querySelectorAll("#vehiclesList input:checked")].map(
          (i) => i.value
        );
      }

      function updateVehicleSummary() {
        let total = 0;
        getSelectedVehicleIds().forEach((id) => {
          const v = VEHICLES.find((v) => v.id === id);
          if (v) total += v.maxLoadKg;
        });

        document.getElementById("vehicleSummary").innerHTML = `
          <strong>Vehicles:</strong> ${getSelectedVehicleIds().length} |
          <strong>Total Capacity:</strong> ${total} KG |
          <strong>Shipment:</strong> ${shipmentData.totalQuantityKg} KG
        `;
      }

      async function loadDoshTypes() {
        const res = await fetch(`${API_BASE}/dosh/types`);
        const json = await res.json();
        DOSH_TYPES = json.data || [];
      }

      function enterEditMode() {
        document.getElementById("editSection").classList.remove("hidden");
        document.getElementById("pickupAddress").value =
          shipmentData.customPickupAddress || "";
        document.getElementById("editItems").innerHTML = "";
        shipmentData.items.forEach((i) =>
          addItem(i.doshType._id, i.quantityKg)
        );
      }

      function cancelEdit() {
        document.getElementById("editSection").classList.add("hidden");
      }

      function addItem(doshType = "", qty = "") {
        const div = document.createElement("div");
        div.className = "item-row";

        const select = document.createElement("select");
        select.innerHTML = `<option value="">-- Select Dosh Type --</option>`;
        DOSH_TYPES.forEach((d) => {
          select.innerHTML += `<option value="${d.id}" ${
            d.id === doshType ? "selected" : ""
          }>${d.name}</option>`;
        });

        const input = document.createElement("input");
        input.type = "number";
        input.value = qty;
        input.placeholder = "Quantity KG";

        const del = document.createElement("button");
        del.textContent = "üóë";
        del.onclick = () => div.remove();

        div.append(select, input, del);
        document.getElementById("editItems").appendChild(div);
      }

      function confirmEditAndApprove() {
        const updates = {};
        const items = [];

        document.querySelectorAll("#editItems .item-row").forEach((row) => {
          const doshType = row.querySelector("select").value;
          const quantityKg = Number(row.querySelector("input").value);
          if (!doshType || quantityKg <= 0) return;
          items.push({ doshType, quantityKg });
        });

        if (!items.length) return alert("Invalid items");

        updates.items = items;

        safePatch(
          `/admin/shipments/${shipmentId}/edit-and-approve`,
          {
            updates,
            representativeId:
              document.getElementById("representativeId").value,
            vehicleIds: getSelectedVehicleIds(),
          },
          "Shipment edited & approved"
        );
      }

      function approve() {
        safePatch(
          `/admin/shipments/${shipmentId}/approve`,
          {
            representativeId:
              document.getElementById("representativeId").value,
            vehicleIds: getSelectedVehicleIds(),
          },
          "Shipment approved"
        );
      }

      function reject() {
        safePatch(
          `/admin/shipments/${shipmentId}/reject`,
          { reason: document.getElementById("note").value.trim() },
          "Shipment rejected"
        );
      }

      loadShipment();
      loadRepresentatives();
      loadVehicles();
      loadDoshTypes();
    </script>
  </body>
</html>
